<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>DDOT</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            max-width: 1200px;
            width: 100%;
            overflow: visible;
            position: relative;
            z-index: 1;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .search-section {
            padding: 40px;
            background: #f8f9fa;
            position: relative;
            z-index: 10;
        }

        .search-container {
            position: relative;
            max-width: 600px;
            margin: 0 auto;
            z-index: 100;
        }

        .search-input {
            width: 100%;
            padding: 20px 60px 20px 20px;
            font-size: 18px;
            border: 3px solid #e9ecef;
            border-radius: 50px;
            outline: none;
            transition: all 0.3s ease;
            background: white;
            position: relative;
            z-index: 101;
        }

        .search-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        }

        .search-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            padding: 12px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 102;
        }

        .search-btn:hover {
            transform: translateY(-50%) scale(1.05);
        }

        .suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 15px;
            margin-top: 5px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 10000;
            display: none;
            box-shadow: 0 8px 25px rgba(0,0,0,0.25);
        }

        .suggestion-item {
            padding: 15px 20px;
            cursor: pointer;
            border-bottom: 1px solid #f8f9fa;
            transition: background-color 0.2s;
        }

        .suggestion-item:hover {
            background-color: #f8f9fa;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .results-container {
            padding: 40px;
            display: none;
        }

        .analysis-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-left: 5px solid #667eea;
        }

        .section-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            margin-right: 15px;
            font-size: 18px;
        }

        .section-title {
            font-size: 1.4em;
            font-weight: 600;
            color: #2c3e50;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .info-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .info-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 1.1em;
            color: #2c3e50;
        }

        .actions-container {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .action-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .action-btn.secondary {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .action-btn.warning {
            background: linear-gradient(135deg, #fd7e14 0%, #e83e8c 100%);
        }

        .action-btn.ai-btn {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            font-size: 16px;
            padding: 15px 30px;
        }

        .action-btn.ai-btn:hover {
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.4);
        }

        .ai-section {
            border-left: 5px solid #ff6b6b;
            background: linear-gradient(135deg, #fff5f5 0%, #ffe8e8 100%);
        }

        .ai-icon {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        }

        .ai-loading {
            border-top: 5px solid #ff6b6b;
        }

        .ai-result {
            background: linear-gradient(145deg, #ffffff 0%, #f8f9ff 100%);
            border: 2px solid #667eea;
            border-radius: 20px;
            padding: 30px;
            margin: 20px 0;
            font-size: 1.1em;
            line-height: 1.8;
            white-space: pre-wrap;
            box-shadow: 0 10px 40px rgba(102, 126, 234, 0.1);
            position: relative;
            overflow: hidden;
        }

        .ai-result::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2, #ff6b6b, #ee5a24);
            background-size: 400% 400%;
            animation: gradient 3s ease infinite;
        }

        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .ai-result h1, .ai-result h2, .ai-result h3 {
            color: #2c3e50;
            margin-top: 25px;
            margin-bottom: 15px;
            font-weight: 700;
        }

        .ai-result h1 {
            font-size: 28px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .ai-result h2 {
            font-size: 24px;
            color: #ff6b6b;
            border-bottom: 2px solid #ff6b6b;
            padding-bottom: 8px;
        }

        .ai-result h3 {
            font-size: 20px;
            color: #667eea;
        }

        .ai-result ul {
            padding-left: 0;
            list-style: none;
        }

        .ai-result li {
            background: white;
            margin: 8px 0;
            padding: 12px 20px;
            border-radius: 10px;
            border-left: 4px solid #27ae60;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            position: relative;
            padding-left: 50px;
        }

        .ai-result li::before {
            content: '✓';
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: #27ae60;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 12px;
        }

        .ai-result strong {
            color: #667eea;
            font-weight: 700;
        }

        .metric-highlight {
            background: linear-gradient(135deg, #fff5f5 0%, #ffe8e8 100%);
            border: 2px solid #ff6b6b;
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
            text-align: center;
        }

        .metric-value {
            font-size: 32px;
            font-weight: 800;
            color: #ff6b6b;
            display: block;
        }

        .metric-label {
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #666;
            margin-top: 5px;
        }

        .calculation-time {
            text-align: right;
            margin-top: 15px;
            padding: 10px;
            background: rgba(255, 107, 107, 0.1);
            border-radius: 10px;
            font-size: 0.9em;
            color: #dc3545;
            font-weight: 600;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #dc3545;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #28a745;
        }

        .property-owners {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }

        .vsgis-indicator {
            display: inline-block;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
            margin-left: 10px;
        }

        .commune-selector {
            margin: 20px 0;
        }

        .commune-selector select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            background: white;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .search-section, .results-container {
                padding: 20px;
            }
            
            .info-grid {
                grid-template-columns: 1fr;
            }
            
            .actions-container {
                flex-direction: column;
            }
        }

        /* === Styles ajoutés pour l'authentification et le footer === */
        .user-menu {
            margin-top: 15px;
        }
        .user-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            margin-left: 10px;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6);
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        .modal-content {
            background: #fff;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            position: relative;
        }
        .modal-content h2 {
            margin-bottom: 20px;
        }
        .modal-content input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
        }
        .modal-content .close {
            position: absolute;
            top: 12px;
            right: 12px;
            cursor: pointer;
            font-size: 20px;
        }
        .footer {
            text-align: center;
            padding: 20px;
            font-size: 0.9em;
            color: #495057;
            background: #f8f9fa;
            margin-top: 30px;
            border-top: 1px solid #e9ecef;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>DDOT</h1>
            <p>Système avancé d'analyse immobilière pour le Valais avec IA<br>
            <small>Données publiques GeoAdmin • Intelligence Artificielle • Règlements communaux</small></p>
            <div class="user-menu">
                <span id="userGreeting"></span>
                <button id="loginBtn" class="user-btn">Se connecter / S'inscrire</button>
                <button id="logoutBtn" class="user-btn" style="display: none;">Se déconnecter</button>
            </div>
        </div>

        <div class="search-section">
            <div class="search-container">
                <input type="text" 
                       class="search-input" 
                       id="searchInput" 
                       placeholder="Recherchez une parcelle, adresse ou coordonnées (ex: Chamoson 435, Sion rue du Rhône 12)">
                <button class="search-btn" id="searchBtn">🔍</button>
                <div class="suggestions" id="suggestions"></div>
            </div>
        </div>

        <div class="results-container" id="resultsContainer">
            <div class="loading" id="loading">
                <div class="loading-spinner"></div>
                <p>Analyse en cours via VSGIS.ch et GeoAdmin...</p>
            </div>

            <div class="loading" id="aiLoading" style="display: none;">
                <div class="loading-spinner ai-loading"></div>
                <p>🧠 Analyse IA en cours... Consultation des règlements communaux et synthèse des contraintes...</p>
            </div>

            <div id="analysisResults" style="display: none;">
                <!-- Informations générales -->
                <div class="analysis-section">
                    <div class="section-header">
                        <div class="section-icon">📋</div>
                        <h2 class="section-title">Informations Générales</h2>
                    </div>
                    <div class="info-grid" id="generalInfo"></div>
                </div>

                <!-- Analyse IA des Contraintes -->
                <div class="analysis-section ai-section" id="aiConstraintsSection" style="display: none;">
                    <div class="section-header">
                        <div class="section-icon ai-icon">🧠</div>
                        <h2 class="section-title">Analyse IA - Contraintes Urbanistiques</h2>
                    </div>
                    <div id="aiConstraintsResult"></div>
                </div>

                <!-- Propriétaires -->
                <div class="analysis-section">
                    <div class="section-header">
                        <div class="section-icon">👥</div>
                        <h2 class="section-title">Informations Cadastrales</h2>
                    </div>
                    <div id="ownersInfo"></div>
                </div>

                <!-- Détails Cadastraux -->
                <div class="analysis-section">
                    <div class="section-header">
                        <div class="section-icon">🗺️</div>
                        <h2 class="section-title">Détails de la Parcelle</h2>
                    </div>
                    <div class="info-grid" id="cadastralInfo"></div>
                </div>

                <!-- Zonage et Réglementation -->
                <div class="analysis-section">
                    <div class="section-header">
                        <div class="section-icon">⚖️</div>
                        <h2 class="section-title">Zonage Public</h2>
                    </div>
                    <div class="info-grid" id="zoningInfo"></div>
                </div>

                <!-- Potentiel de Développement -->
                <div class="analysis-section">
                    <div class="section-header">
                        <div class="section-icon">📈</div>
                        <h2 class="section-title">Potentiel de Développement</h2>
                    </div>
                    <div class="info-grid" id="developmentInfo"></div>
                </div>

                <!-- Actions -->
                <div class="actions-container">
                    <button class="action-btn ai-btn" id="aiConstraintsBtn" onclick="analyzeWithAI()">
                        🧠 Analyse IA - Contraintes
                    </button>
                    <button class="action-btn" onclick="generatePDF()">
                        📄 Générer Rapport PDF
                    </button>
                    <button class="action-btn secondary" id="rdppfBtn">
                        📋 Télécharger RDPPF
                    </button>
                    <button class="action-btn warning" id="regulationBtn" style="display:none;">
                        📚 Règlement Communal
                    </button>
                    <button class="action-btn" onclick="newSearch()">
                        🔄 Nouvelle Recherche
                    </button>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        DDOT - Système d'analyse cadastrale avec IA pour le Valais<br>Powered by Dylan Taccoz et Oktay Demir
    </footer>

    <!-- Modal Authentification -->
    <div class="modal" id="authModal">
        <div class="modal-content">
            <span class="close" id="closeAuth">&times;</span>
            <h2 id="authTitle">Connexion</h2>
            <input type="text" id="authUsername" placeholder="Nom d'utilisateur">
            <input type="password" id="authPassword" placeholder="Mot de passe">
            <button id="authSubmitBtn" class="action-btn" style="margin-top:15px;">Se connecter</button>
            <p id="switchAuth" style="margin-top:10px; font-size: 0.9em;">
                Pas de compte ? <a href="#" id="switchToRegister">Inscrivez-vous</a>
            </p>
        </div>
    </div>

    <script>
        // Base de données des règlements communaux
        const communalRegulations = {
            'Sion': 'https://www.sion.ch/_doc/5100898',
            'Martigny': 'https://www.martigny.ch/files/Constructions-Reglement.pdf',
            'Chamoson': 'https://www.chamoson.net/files/49/construction-1.pdf',
            'Collonges': 'https://www.vs.ch/documents/17311/5745820/19910612_coll_rccz.pdf',
            'Savièse': 'https://www.saviese.ch/data/documents/reglements/communaux-bourgeoisiaux/reglement-constructions-zones.pdf',
            'Val de Bagnes': 'https://www.valdebagnes.ch/_doc/3861622',
            'Vollèges': 'https://www.valdebagnes.ch/_doc/3013939',
            'Monthey': 'https://www.monthey.ch/documents/reglement-constructions.pdf',
            'Sierre': 'https://www.sierre.ch/documents/reglement-urbanisme.pdf',
            'Vétroz': 'https://www.vetroz.ch/documents/reglement-construction.pdf',
            'Conthey': 'https://www.conthey.ch/documents/reglement-zones.pdf',
            'Fully': 'https://www.fully.ch/documents/reglement-constructions.pdf',
            'Ayent': 'https://www.ayent.ch/documents/reglement-construction.pdf',
            'Nendaz': 'https://www.nendaz.ch/documents/reglement-urbanisme.pdf',
            'Leytron': 'https://www.leytron.ch/documents/reglement-constructions.pdf',
            'Riddes': 'https://www.riddes.ch/documents/reglement-zones.pdf',
            'Saxon': 'https://www.saxon.ch/documents/reglement-construction.pdf',
            'Orsières': 'https://www.orsieres.ch/documents/reglement-communal.pdf',
            'Bovernier': 'https://www.bovernier.ch/documents/reglement-constructions.pdf'
        };

        // Variables globales
        let currentData = null;
        let searchTimeout = null;
        let currentCoordinates = null;

        // Fonction de test pour déboguer
        window.testSuggestions = function() {
            console.log('Test des suggestions...');
            const suggestions = document.getElementById('suggestions');
            suggestions.innerHTML = `
                <div class="suggestion-item" onclick="alert('Test cliqué!')">
                    🧪 Test Suggestion 1
                </div>
                <div class="suggestion-item" onclick="alert('Test cliqué!')">
                    🧪 Test Suggestion 2
                </div>
            `;
            suggestions.style.display = 'block';
            console.log('Suggestions de test affichées');
        };

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 DOM chargé - Initialisation DDOT');
            
            const searchInput = document.getElementById('searchInput');
            const searchBtn = document.getElementById('searchBtn');
            const suggestions = document.getElementById('suggestions');

            if (!searchInput || !searchBtn || !suggestions) {
                console.error('❌ Éléments DOM manquants:', { searchInput, searchBtn, suggestions });
                return;
            }

            console.log('✅ Éléments DOM trouvés, ajout des événements...');

            searchInput.addEventListener('input', function(e) {
                console.log('📝 Input event:', e.target.value);
                handleSearchInput();
            });
            
            searchInput.addEventListener('keypress', function(e) {
                console.log('⌨️ Keypress event:', e.key);
                if (e.key === 'Enter') {
                    performSearch();
                }
            });
            
            searchBtn.addEventListener('click', function(e) {
                console.log('🔍 Search button clicked');
                performSearch();
            });

            // Certains navigateurs (Safari / mobiles) déclenchent mal l'événement "input" ; on ajoute un fallback
            searchInput.addEventListener('keyup', function() {
                handleSearchInput();
            });

            // Fermer les suggestions en cliquant ailleurs
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.search-container')) {
                    suggestions.style.display = 'none';
                }
            });

            // === Auth UI ===
            const loginBtn = document.getElementById('loginBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            updateUserUI();
            if (loginBtn) loginBtn.addEventListener('click', () => openAuthModal('login'));
            if (logoutBtn) logoutBtn.addEventListener('click', logout);
        });

        function handleSearchInput() {
            console.log('🔤 handleSearchInput appelée');
            
            const query = document.getElementById('searchInput').value;
            const suggestions = document.getElementById('suggestions');

            console.log('📄 Query:', `"${query}"`, 'Length:', query.length);

            clearTimeout(searchTimeout);

            if (query.length < 2) {
                console.log('⚠️ Query trop courte, on cache les suggestions');
                suggestions.style.display = 'none';
                return;
            }

            console.log('✅ Query suffisamment longue, affichage du loading');
            
            // Afficher un indicateur de chargement
            suggestions.innerHTML = `
                <div class="suggestion-item" style="color: #6c757d; cursor: default;">
                    ⏳ Recherche en cours...
                </div>
            `;
            suggestions.style.display = 'block';
            
            console.log('⏰ Programmation du timeout de 300ms');

            searchTimeout = setTimeout(() => {
                console.log('⏱️ Timeout exécuté, appel de showSuggestions');
                showSuggestions(query);
            }, 300);
        }

        async function showSuggestions(query) {
            console.log("Timeout exécuté, appel de showSuggestions");
            console.log("Recherche suggestions pour:", `"${query}"`);
            try {
                // Détection automatique de l'environnement
                const isProduction = window.location.protocol === 'https:';
                const baseUrl = isProduction ? '' : 'http://127.0.0.1:3001';
                const url = `${baseUrl}/api/geoadmin-search?searchText=${encodeURIComponent(query)}&type=locations&origins=parcel,address,gg25&limit=8&sr=2056`;
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                console.log('Réponse proxy:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Erreur réponse:', errorText);
                    throw new Error(`Erreur de recherche: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Données reçues:', data);
                
                if (data.results && data.results.length > 0) {
                    let suggestionsHTML = '';
                    
                    data.results.forEach((result, index) => {
                        const label = result.attrs.label.replace(/<[^>]*>/g, '');
                        
                        suggestionsHTML += `
                            <div class="suggestion-item" onclick="selectSuggestionByIndex(${index})" data-index="${index}">
                                ${label}
                            </div>
                        `;
                    });
                    
                    suggestions.innerHTML = suggestionsHTML;
                    suggestions.style.display = 'block';
                    console.log('Suggestions affichées:', data.results.length);
                    
                    // Stocker les résultats pour l'utilisation dans selectSuggestionByIndex
                    window.currentSuggestions = data.results;
                } else {
                    console.log('Aucun résultat trouvé');
                    suggestions.style.display = 'none';
                }
            } catch (error) {
                console.error('Erreur suggestions:', error);
                suggestions.style.display = 'none';
                
                // Afficher un message d'erreur temporaire dans les suggestions
                suggestions.innerHTML = `
                    <div class="suggestion-item" style="color: #dc3545; cursor: default;">
                        ❌ Erreur de recherche - ${error.message}
                    </div>
                `;
                suggestions.style.display = 'block';
                
                // Cacher après 3 secondes
                setTimeout(() => {
                    suggestions.style.display = 'none';
                }, 3000);
            }
        }

        function selectSuggestionByIndex(index) {
            if (window.currentSuggestions && window.currentSuggestions[index]) {
                const result = window.currentSuggestions[index];
                const cleanLabel = result.attrs.label.replace(/<[^>]*>/g, '');
                
                document.getElementById('searchInput').value = cleanLabel;
                document.getElementById('suggestions').style.display = 'none';
                
                // Déclencher la recherche directement avec les données de la suggestion
                performSearchWithResult(result);
            }
        }

        function selectSuggestion(label, x, y) {
            // Fonction legacy maintenue pour compatibilité
            const cleanLabel = label.replace(/<[^>]*>/g, '');
            document.getElementById('searchInput').value = cleanLabel;
            document.getElementById('suggestions').style.display = 'none';
            performSearch();
        }

        async function performSearchWithResult(result) {
            showLoading();

            try {
                // Extraire les coordonnées pour l'IA
                currentCoordinates = {
                    lat: result.attrs.y || 46.2,
                    lon: result.attrs.x || 7.3
                };

                // Créer les données directement avec le résultat de la suggestion
                currentData = {
                    general: {
                        adresse: result.attrs.label.replace(/<[^>]*>/g, ''),
                        coordonnees: result.attrs.x && result.attrs.y ? 
                            `${result.attrs.x.toFixed(2)}, ${result.attrs.y.toFixed(2)}` : 
                            'Coordonnées non disponibles',
                        systeme_ref: "CH1903+ / LV95 (EPSG:2056)",
                        date_analyse: new Date().toLocaleDateString('fr-CH'),
                        type_objet: result.attrs.origin || 'Parcelle'
                    },
                    cadastral: {
                        id_federal: result.attrs.featureId || result.id || 'Non disponible',
                        commune: extractCommune(result.attrs.label),
                        canton: 'Valais (VS)',
                        statut: 'Données publiques GeoAdmin',
                        bbox: result.attrs.geom_st_box2d || 'Non disponible'
                    },
                    zonage: {
                        source: 'Informations disponibles auprès des services communaux',
                        note: 'Consultation du règlement communal recommandée'
                    }
                };
                
                displayResults(currentData);

            } catch (error) {
                console.error('Erreur lors de l\'affichage:', error);
                showError('Erreur lors de l\'affichage des résultats: ' + error.message);
            }
        }

        async function performSearch() {
            const query = document.getElementById('searchInput').value.trim();
            
            if (!query) {
                alert('Veuillez saisir une recherche');
                return;
            }

            showLoading();

            try {
                // Recherche via notre proxy GeoAdmin
                const searchResponse = await fetch(
                    `/api/geoadmin-search?searchText=${encodeURIComponent(query)}&type=locations&origins=parcel,address,gg25&limit=5&sr=2056`
                );
                
                if (!searchResponse.ok) {
                    throw new Error(`Erreur API GeoAdmin: ${searchResponse.status}`);
                }
                
                const searchData = await searchResponse.json();
                
                if (!searchData.results || searchData.results.length === 0) {
                    throw new Error('Aucun résultat trouvé dans GeoAdmin');
                }

                const result = searchData.results[0];
                
                // Extraire les coordonnées pour l'IA
                currentCoordinates = {
                    lat: result.attrs.y || 46.2,
                    lon: result.attrs.x || 7.3
                };
                
                // Créer les données avec les informations GeoAdmin
                currentData = {
                    general: {
                        adresse: result.attrs.label.replace(/<[^>]*>/g, ''),
                        coordonnees: result.attrs.x && result.attrs.y ? 
                            `${result.attrs.x.toFixed(2)}, ${result.attrs.y.toFixed(2)}` : 
                            'Coordonnées non disponibles',
                        systeme_ref: "CH1903+ / LV95 (EPSG:2056)",
                        date_analyse: new Date().toLocaleDateString('fr-CH'),
                        type_objet: result.attrs.origin || 'Parcelle'
                    },
                    cadastral: {
                        id_federal: result.attrs.featureId || result.id || 'Non disponible',
                        commune: extractCommune(result.attrs.label),
                        canton: 'Valais (VS)',
                        statut: 'Données publiques GeoAdmin',
                        bbox: result.attrs.geom_st_box2d || 'Non disponible'
                    },
                    zonage: {
                        source: 'Informations disponibles auprès des services communaux',
                        note: 'Consultation du règlement communal recommandée'
                    }
                };
                
                displayResults(currentData);

            } catch (error) {
                console.error('Erreur lors de la recherche:', error);
                showError('Erreur lors de l\'analyse: ' + error.message + '. Veuillez vérifier votre recherche.');
            }
        }

        function extractCommune(label) {
            const communeNames = ['Sion', 'Martigny', 'Chamoson', 'Monthey', 'Sierre', 'Collonges', 'Savièse', 'Fully', 'Vétroz', 'Conthey', 'Ayent', 'Nendaz', 'Val de Bagnes', 'Bagnes'];
            
            for (const commune of communeNames) {
                if (label.toLowerCase().includes(commune.toLowerCase())) {
                    return commune;
                }
            }
            
            return 'Commune non identifiée';
        }

        async function analyzeWithAI() {
            if (!currentCoordinates) {
                alert('Veuillez d\'abord rechercher une parcelle');
                return;
            }

            const aiLoadingDiv = document.getElementById('aiLoading');
            const aiSection = document.getElementById('aiConstraintsSection');
            const aiResult = document.getElementById('aiConstraintsResult');
            const aiBtn = document.getElementById('aiConstraintsBtn');

            // Afficher le loading IA
            aiLoadingDiv.style.display = 'block';
            aiBtn.disabled = true;
            aiBtn.textContent = '🧠 Analyse en cours...';

            try {
                // Détection automatique de l'environnement pour l'API IA
                const isProduction = window.location.protocol === 'https:';
                const baseUrl = isProduction ? '' : 'http://127.0.0.1:3001';
                const response = await fetch(`${baseUrl}/api/ia-constraints`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        coordinates: `${currentCoordinates.lat},${currentCoordinates.lon}`,
                        address: currentData?.general?.adresse || `${currentCoordinates.lat},${currentCoordinates.lon}`,
                        commune: currentData?.cadastral?.commune,
                        parcelId: currentData?.cadastral?.id_federal
                    }),
                });

                if (!response.ok) {
                    throw new Error('Erreur API');
                }

                const data = await response.json();

                // Afficher les résultats IA avec formatage avancé
                const formattedContent = formatAIResponse(data.constraints);
                
                aiResult.innerHTML = `
                    <div class="ai-result">
                        ${formattedContent}
                    </div>
                    <div class="calculation-time">
                        ⏱ Temps de calcul IA: ${(data.elapsedMs / 1000).toFixed(1)} secondes
                        <br>📊 Source: ${data.source || 'Données communales'}
                        <br>🏛️ Zone: ${data.zone || 'Zone mixte'}
                        <br>🏘️ Commune: ${data.commune || 'Canton du Valais'}
                    </div>
                `;

                aiSection.style.display = 'block';

            } catch (error) {
                console.error('Erreur IA:', error);
                aiResult.innerHTML = `
                    <div class="error-message">
                        ❌ Erreur lors de l'analyse IA: ${error.message}
                    </div>
                `;
                aiSection.style.display = 'block';
            } finally {
                aiLoadingDiv.style.display = 'none';
                aiBtn.disabled = false;
                aiBtn.textContent = '🧠 Analyse IA - Contraintes';
            }
        }

        // Fonction de formatage avancé pour les résultats IA
        function formatAIResponse(content) {
            if (!content) return 'Aucun contenu disponible';
            
            let formatted = content;
            
            // Conversion des titres en HTML avec style
            formatted = formatted.replace(/^#\s+(.+)/gm, '<h1>$1</h1>');
            formatted = formatted.replace(/^##\s+(.+)/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^###\s+(.+)/gm, '<h3>$1</h3>');
            
            // Mise en évidence des métriques importantes
            formatted = formatted.replace(/(\d+(?:\.\d+)?)\s*(m²|m³|m|%|logements?)/gi, 
                '<span class="metric-highlight"><span class="metric-value">$1</span><span class="metric-label">$2</span></span>');
            
            // Formatage des listes avec puces
            formatted = formatted.replace(/^-\s+(.+)/gm, '<li>$1</li>');
            formatted = formatted.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');
            
            // Mise en évidence des mots-clés importants
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            // Formatage des sections importantes
            formatted = formatted.replace(/(ÉTUDE DE FAISABILITÉ|PRESCRIPTIONS DÉTAILLÉES|AMÉNAGEMENTS OBLIGATOIRES|PROCÉDURES ADMINISTRATIVES|ASPECTS ÉCONOMIQUES)/gi, 
                '<span style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 8px 16px; border-radius: 20px; font-weight: bold; display: inline-block; margin: 10px 0;">$1</span>');
            
            // Conversion des sauts de ligne
            formatted = formatted.replace(/\n/g, '<br>');
            
            return formatted;
        }

        function displayResults(data) {
            // S'assurer que les éléments existent avant de les modifier
            const loading = document.getElementById('loading');
            const analysisResults = document.getElementById('analysisResults');
            const generalInfo = document.getElementById('generalInfo');
            const ownersInfo = document.getElementById('ownersInfo');
            const cadastralInfo = document.getElementById('cadastralInfo');
            const zoningInfo = document.getElementById('zoningInfo');

            if (!loading || !analysisResults || !generalInfo || !ownersInfo || !cadastralInfo || !zoningInfo) {
                console.error('Éléments DOM manquants');
                showError('Erreur d\'affichage: éléments de page manquants');
                return;
            }

            loading.style.display = 'none';
            analysisResults.style.display = 'block';

            // Informations générales
            generalInfo.innerHTML = `
                <div class="info-item">
                    <div class="info-label">Adresse/Localisation</div>
                    <div class="info-value">${data.general.adresse}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Coordonnées</div>
                    <div class="info-value">${data.general.coordonnees}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Système de référence</div>
                    <div class="info-value">${data.general.systeme_ref}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Date d'analyse</div>
                    <div class="info-value">${data.general.date_analyse}</div>
                </div>
            `;

            // Informations cadastrales publiques
            ownersInfo.innerHTML = `
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">ID Fédéral</div>
                        <div class="info-value">${data.cadastral.id_federal}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Commune</div>
                        <div class="info-value">${data.cadastral.commune}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Canton</div>
                        <div class="info-value">${data.cadastral.canton}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Source des données</div>
                        <div class="info-value">${data.cadastral.statut}</div>
                    </div>
                </div>
                <div style="margin-top: 15px; padding: 15px; background: #e3f2fd; border-radius: 10px; border-left: 4px solid #2196f3;">
                    <p><strong>ℹ️ Informations importantes :</strong></p>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li>Les données de propriétaires ne sont pas publiques</li>
                        <li>Pour les informations détaillées : contactez le cadastre communal</li>
                        <li>Utilisez l'IA pour analyser les contraintes de construction</li>
                    </ul>
                </div>
            `;

            // Détails de la parcelle
            cadastralInfo.innerHTML = `
                <div class="info-item">
                    <div class="info-label">Bounding Box</div>
                    <div class="info-value">${data.cadastral.bbox}</div>
                </div>
                <div style="margin-top: 15px; padding: 15px; background: #fff3cd; border-radius: 10px; border-left: 4px solid #ffc107;">
                    <p><strong>📋 Informations complémentaires disponibles :</strong></p>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li>Surface exacte de la parcelle</li>
                        <li>Limites cadastrales précises</li>
                        <li>Servitudes et charges foncières</li>
                        <li>Données de propriétaire</li>
                    </ul>
                    <p><em>Contactez le service du cadastre de ${data.cadastral.commune} pour ces informations.</em></p>
                </div>
            `;

            // Zonage public
            zoningInfo.innerHTML = `
                <div class="info-item">
                    <div class="info-label">Source d'information</div>
                    <div class="info-value">${data.zonage.source}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Recommandation</div>
                    <div class="info-value">${data.zonage.note}</div>
                </div>
                <div style="margin-top: 15px; padding: 15px; background: #fff3cd; border-radius: 10px; border-left: 4px solid #ffc107;">
                    <p><strong>🧠 Analyse IA disponible :</strong></p>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li>Synthèse automatique des contraintes urbanistiques</li>
                        <li>Analyse des règlements communaux pertinents</li>
                        <li>Identification des zones et prescriptions</li>
                        <li>Recommandations pour votre projet</li>
                    </ul>
                    <p><em>Cliquez sur "🧠 Analyse IA - Contraintes" pour commencer.</em></p>
                </div>
            `;

            // Cacher la section potentiel de développement
            const developmentSection = document.querySelector('#developmentInfo');
            if (developmentSection) {
                const parentSection = developmentSection.closest('.analysis-section');
                if (parentSection) {
                    parentSection.style.display = 'none';
                }
            }

            // Configuration des boutons d'action
            setupActionButtons(data);
        }

        function setupActionButtons(data) {
            // Bouton RDPPF
            const rdppfBtn = document.getElementById('rdppfBtn');
            if (rdppfBtn) {
                rdppfBtn.onclick = () => {
                    window.open(`https://www.rdppf.admin.ch/`, '_blank');
                };
            }

            // Bouton Règlement Communal
            const regulationBtn = document.getElementById('regulationBtn');
            if (regulationBtn) {
                const communeKey = data.cadastral.commune;
                
                if (communalRegulations[communeKey]) {
                    regulationBtn.onclick = () => {
                        window.open(communalRegulations[communeKey], '_blank');
                    };
                    regulationBtn.style.display = 'inline-flex';
                    regulationBtn.innerHTML = '📚 Règlement Communal';
                } else {
                    regulationBtn.style.display = 'none';
                }
            }
        }

        function generatePDF() {
            if (!currentData) {
                alert('Aucune donnée à exporter');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // En-tête
            doc.setFontSize(20);
            doc.text('Rapport de Parcelle - DDOT', 20, 30);
            doc.setFontSize(12);
            doc.text(`Généré le ${new Date().toLocaleDateString('fr-CH')}`, 20, 40);
            doc.text('Données publiques GeoAdmin', 20, 48);

            // Informations générales
            doc.setFontSize(16);
            doc.text('1. Informations Générales', 20, 70);
            doc.setFontSize(11);
            doc.text(`Localisation: ${currentData.general.adresse}`, 25, 85);
            doc.text(`Coordonnées: ${currentData.general.coordonnees}`, 25, 95);
            doc.text(`Date d'analyse: ${currentData.general.date_analyse}`, 25, 105);

            // Informations cadastrales
            doc.setFontSize(16);
            doc.text('2. Informations Cadastrales', 20, 125);
            doc.setFontSize(11);
            doc.text(`ID Fédéral: ${currentData.cadastral.id_federal}`, 25, 140);
            doc.text(`Commune: ${currentData.cadastral.commune}`, 25, 150);
            doc.text(`Canton: ${currentData.cadastral.canton}`, 25, 160);
            doc.text(`Source: ${currentData.cadastral.statut}`, 25, 170);

            // Informations importantes
            doc.setFontSize(16);
            doc.text('3. Informations Importantes', 20, 190);
            doc.setFontSize(11);
            doc.text('• Les données de propriétaires ne sont pas publiques', 25, 205);
            doc.text('• Contactez le cadastre communal pour les détails', 25, 215);
            doc.text('• Consultez le règlement communal pour les contraintes', 25, 225);

            // Pied de page
            doc.setFontSize(8);
            doc.text('© DDOT - Données publiques GeoAdmin', 20, 285);
            doc.text('Powered by Dylan Taccoz et Oktay Demir', 140, 285);

            doc.save(`parcelle-${currentData.cadastral.commune}-${currentData.general.date_analyse}.pdf`);
        }

        function showLoading() {
            const resultsContainer = document.getElementById('resultsContainer');
            const loading = document.getElementById('loading');
            const analysisResults = document.getElementById('analysisResults');
            const aiLoading = document.getElementById('aiLoading');
            
            if (resultsContainer) resultsContainer.style.display = 'block';
            if (loading) loading.style.display = 'block';
            if (analysisResults) analysisResults.style.display = 'none';
            if (aiLoading) aiLoading.style.display = 'none';
        }

        function showError(message) {
            const loading = document.getElementById('loading');
            const analysisResults = document.getElementById('analysisResults');
            const aiLoading = document.getElementById('aiLoading');
            
            if (loading) loading.style.display = 'none';
            if (aiLoading) aiLoading.style.display = 'none';
            if (analysisResults) {
                analysisResults.innerHTML = `
                    <div class="error-message">
                        <h3>❌ Erreur</h3>
                        <p>${message}</p>
                        <button class="action-btn" onclick="newSearch()" style="margin-top: 15px;">
                            🔄 Nouvelle Recherche
                        </button>
                    </div>
                `;
                analysisResults.style.display = 'block';
            }
        }

        function newSearch() {
            const resultsContainer = document.getElementById('resultsContainer');
            const searchInput = document.getElementById('searchInput');
            const aiSection = document.getElementById('aiConstraintsSection');
            
            if (resultsContainer) resultsContainer.style.display = 'none';
            if (searchInput) {
                searchInput.value = '';
                searchInput.focus();
            }
            if (aiSection) aiSection.style.display = 'none';
            currentData = null;
            currentCoordinates = null;
        }

        /* === Gestion locale des utilisateurs === */
        function getUsers() {
            return JSON.parse(localStorage.getItem('ddot_users') || '[]');
        }
        function saveUsers(users) {
            localStorage.setItem('ddot_users', JSON.stringify(users));
        }
        function setCurrentUser(username) {
            localStorage.setItem('ddot_currentUser', username);
        }
        function getCurrentUser() {
            return localStorage.getItem('ddot_currentUser');
        }
        function logout() {
            localStorage.removeItem('ddot_currentUser');
            updateUserUI();
        }
        function updateUserUI() {
            const greeting = document.getElementById('userGreeting');
            const loginBtn = document.getElementById('loginBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            const user = getCurrentUser();
            if (user) {
                greeting.textContent = `👋 Bonjour, ${user}`;
                if (loginBtn) loginBtn.style.display = 'none';
                if (logoutBtn) logoutBtn.style.display = 'inline-block';
            } else {
                greeting.textContent = '';
                if (loginBtn) loginBtn.style.display = 'inline-block';
                if (logoutBtn) logoutBtn.style.display = 'none';
            }
        }
        let authMode = 'login';
        function openAuthModal(mode='login') {
            authMode = mode;
            const modal = document.getElementById('authModal');
            const title = document.getElementById('authTitle');
            const submitBtn = document.getElementById('authSubmitBtn');
            const switchAuth = document.getElementById('switchAuth');
            title.textContent = mode === 'login' ? 'Connexion' : 'Inscription';
            submitBtn.textContent = mode === 'login' ? 'Se connecter' : "S'inscrire";
            switchAuth.innerHTML = mode === 'login'
                ? 'Pas de compte ? <a href="#" id="switchToRegister">Inscrivez-vous</a>'
                : 'Déjà un compte ? <a href="#" id="switchToLogin">Connectez-vous</a>';
            modal.style.display = 'flex';
            setTimeout(() => {
                const switchLink = mode === 'login' ? document.getElementById('switchToRegister') : document.getElementById('switchToLogin');
                if (switchLink) switchLink.addEventListener('click', (e) => { e.preventDefault(); openAuthModal(mode === 'login' ? 'register' : 'login'); });
            }, 0);
        }
        function closeAuthModal() {
            document.getElementById('authModal').style.display = 'none';
            document.getElementById('authUsername').value = '';
            document.getElementById('authPassword').value = '';
        }
        document.getElementById('closeAuth').addEventListener('click', closeAuthModal);
        window.addEventListener('click', (e) => { if (e.target.id === 'authModal') closeAuthModal(); });
        document.getElementById('authSubmitBtn').addEventListener('click', handleAuthSubmit);
        function handleAuthSubmit() {
            const username = document.getElementById('authUsername').value.trim();
            const password = document.getElementById('authPassword').value.trim();
            if (!username || !password) {
                alert('Veuillez remplir tous les champs');
                return;
            }
            const users = getUsers();
            if (authMode === 'register') {
                if (users.find(u => u.username === username)) {
                    alert('Nom d\'utilisateur déjà pris');
                    return;
                }
                users.push({ username, password });
                saveUsers(users);
                setCurrentUser(username);
                closeAuthModal();
                updateUserUI();
                alert('Inscription réussie !');
            } else {
                const user = users.find(u => u.username === username && u.password === password);
                if (!user) {
                    alert('Identifiants invalides');
                    return;
                }
                setCurrentUser(username);
                closeAuthModal();
                updateUserUI();
            }
        }
    </script>
</body>
</html> 